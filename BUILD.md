# Maximus BBS - Modern Build Guide

## Overview

Maximus BBS is a classic bulletin board system originally written for DOS/OS2/Windows, 
ported to UNIX around 2003. This document covers building on modern systems including 
Linux, FreeBSD, and macOS (Darwin).

## Architecture

### Component Libraries (Build Order)

```
1. unix/libcompat.so    - UNIX compatibility layer (DOS/OS2 API emulation)
2. slib/libmax.so       - Core utility library  
3. msgapi/libmsgapi.so  - Message base API (Squish/SDM format)
4. btree/libmaxbt.so    - B-tree indexing library (C++)
5. btree/libmaxdb.so    - Database/tracking library (C++)
6. prot/libxfer.so      - File transfer protocols (X/Y/Zmodem)
7. mex/libmexvm.so      - MEX scripting VM
8. comdll/libcomm.so    - Communications drivers (IP/modem)
```

### Programs

- **squish** - Message tosser/scanner for FidoNet
- **max** - Main BBS executable  
- **sqafix** - Squish area fix utility
- **util/** - Various utilities (maid, silt, mecca, mex compiler, etc.)

## Dependencies

### Required
- GCC or Clang (C/C++ compiler)
- GNU Make 3.79+
- Bison or Yacc
- ncurses development libraries

### Optional
- makedepend (for dependency tracking)

### Platform-Specific

**Linux:**
```bash
apt install build-essential libncurses-dev bison
```

**FreeBSD:**
```bash
pkg install gmake gcc ncurses bison
```

**macOS (Darwin):**
```bash
xcode-select --install   # Provides clang, make, bison
# ncurses is included in macOS SDK
```

## Build Instructions

### Prerequisites

**Important:** The `install_tree/` directory must exist with the base configuration
files. This is normally included in source distributions. If missing, obtain it
from the Maximus distribution archives.

### Quick Start

```bash
# For local development build (recommended)
./configure --prefix=$(pwd)/build
make build
make install

# For system-wide installation  
./configure --prefix=/var/max
make build
sudo make install
```

The `make install` target:
1. Copies `install_tree/` to PREFIX (first install only)
2. Adjusts paths in config files for your PREFIX
3. Compiles language files, help screens, control files, and MEX scripts
4. Creates initial user database

### Step-by-Step

```bash
# 1. Configure
./configure --prefix=/var/max

# 2. Build Squish only
make squish

# 3. Build everything
make build

# 4. Install
make install
```

### Build Targets

| Target | Description |
|--------|-------------|
| `build` | Build all components (squish, max, sqafix) |
| `squish` | Build Squish message tosser only |
| `max` | Build Maximus BBS only |
| `sqafix` | Build SqaFix only |
| `squish_install` | Build and install Squish |
| `max_install` | Build and install Maximus |
| `config_install` | Install configuration files |
| `clean` | Remove build artifacts |
| `distclean` | Remove all generated files |

## Library Dependencies

```
libcompat.so  <- ncurses (standalone)
libmax.so     <- libcompat.so, ncurses
libmsgapi.so  <- libmax.so, libcompat.so
libmaxbt.so   <- libcompat.so (C++)
libmaxdb.so   <- libmaxbt.so, libcompat.so (C++)
libxfer.so    <- libmax.so, libcompat.so
libmexvm.so   <- libmax.so, libcompat.so
libcomm.so    <- libmax.so, libcompat.so
```

## Platform Support

| Platform | Status | Notes |
|----------|--------|-------|
| Linux x86_64 | ✓ Supported | Primary development platform |
| Linux ARM64 | ✓ Should work | Untested |
| FreeBSD | ✓ Supported | Use gmake |
| macOS (Darwin) | ✓ Supported | ARM64 and x86_64 |
| Solaris/SunOS | ✓ Supported | Big-endian issues with FidoNet packets |
| Windows | ✗ Broken | Would need significant work |

## Post-Install: Getting Started

After `make install`, you have a working BBS skeleton in your PREFIX directory.

### Directory Structure

```
$PREFIX/
├── bin/           # Executables (max, squish, silt, mex, maid, mecca, etc.)
├── lib/           # Shared libraries
├── etc/           # Configuration files
│   ├── max.ctl    # Main control file (includes other .ctl files)
│   ├── max.prm    # Compiled PRM file (generated by silt)
│   ├── marea.dat  # Message area data (generated by silt)
│   ├── farea.dat  # File area data (generated by silt)
│   ├── access.ctl # Access levels/privileges
│   ├── msgarea.ctl# Message area definitions
│   ├── filearea.ctl# File area definitions
│   ├── menus.ctl  # Menu definitions
│   ├── lang/      # Language files
│   ├── help/      # Help screens (compiled from .mec)
│   └── misc/      # Misc display files (compiled from .mec)
└── m/             # MEX scripts (.vm compiled from .mex)
```

### Key Utilities

| Utility | Purpose |
|---------|--------|
| `silt`  | Compiles .ctl files → .prm + area data files |
| `maid`  | Compiles language files (.mad) |
| `mecca` | Compiles display files (.mec → .bbs) |
| `mex`   | Compiles MEX scripts (.mex → .vm) |
| `max`   | Main BBS executable |
| `squish`| FidoNet message tosser/scanner |

### Manual Recompilation

If you edit configuration files, recompile with:

```bash
cd $PREFIX

# Recompile everything from max.ctl (recommended)
bin/silt etc/max -x

# Or selectively:
bin/silt etc/max -p      # PRM file only (etc/max.prm)
bin/silt etc/max -a      # Area data files (marea.dat, marea.idx, farea.dat, farea.idx)
bin/silt etc/max -m      # Menu files only (etc/menus/*.mnu)
bin/silt etc/max -p -a   # PRM + area data (minimum for max to run)

# Recompile language files
bin/maid etc/lang/english -d -s -petc/max

# Recompile display files
bin/mecca etc/help/*.mec
bin/mecca etc/misc/*.mec

# Recompile MEX scripts (bash/zsh)
export MEX_INCLUDE=$PREFIX/m
for f in m/*.mex; do bin/mex "$f"; done

# Recompile MEX scripts (fish)
# set -x MEX_INCLUDE $PREFIX/m
# for f in m/*.mex; bin/mex "$f"; end
```

### Environment Setup

Set your PREFIX path before running commands. The syntax varies by shell:

**Bash/Zsh:**
```bash
export PREFIX=/path/to/maximus/build
export MEX_INCLUDE=$PREFIX/m
export PATH="$PREFIX/bin:$PATH"
```

**Fish:**
```fish
set -x PREFIX /path/to/maximus/build
set -x MEX_INCLUDE $PREFIX/m
set -x PATH $PREFIX/bin $PATH
```

To make permanent, add to your shell config (`~/.bashrc`, `~/.zshrc`, or `~/.config/fish/config.fish`).

### Running the BBS

```bash
cd $PREFIX

# Create initial user database (first time only)
bin/max etc/max -c

# Run in local mode for testing
bin/max etc/max -w -pt1

# Run with wait-for-call (telnet/modem)
bin/max etc/max -w
```

### Configuration Workflow

1. Edit `.ctl` files in `etc/` to customize your BBS
2. Run `bin/silt etc/max -x` to recompile
3. Test with `bin/max etc/max -w -pt1`
4. Set up telnet access via inetd/xinetd/systemd (see Telnet Server section)

## Known Issues

### macOS/Darwin
- Uses clang instead of GCC (some flags differ)
- Shared library linking requires explicit dependencies  
- Config files contain ANSI codes; sed requires `LC_ALL=C` for processing
- ARM64 requires removing `packed` attribute from pointer-containing structs
- `malloc.h` is `stdlib.h` on macOS
- `pty.h` is `util.h` on macOS
- `/bin/true` is at `/usr/bin/true`

### General
- Big-endian platforms may have issues with FidoNet packet handling
- C++ code in btree/ generates warnings with modern compilers
- `card.mex` has source code bugs (3 errors) - not a build issue

## Telnet Server

The system supports telnet via `maxcomm` which acts as a bridge between 
inetd/xinetd and the running Maximus tasks via UNIX domain sockets.

### Setup with inetd

```
# /etc/inetd.conf
telnet stream tcp nowait bbs /path/to/maxcomm maxcomm
```

### Setup with systemd

See `docs/` for systemd socket activation examples.

## Cross-Compilation

### Windows (MinGW)

Not currently supported. Would require:
- Restoring Windows-specific code paths
- Creating MinGW build configuration
- Handling Windows socket API differences

### Linux to macOS

Use osxcross or native macOS for best results.

## File Locations

| Path | Purpose |
|------|---------|
| `/var/max/bin/` | Executables |
| `/var/max/lib/` | Shared libraries |
| `/var/max/etc/` | Configuration files |
| `/var/max/m/` | MEX scripts |

## Debugging

```bash
# Build with debug symbols
./configure --build=DEBUG

# Run with tracing
strace -f ./bin/max -w -pt1  # Linux
ktrace ./bin/max -w -pt1     # BSD
dtruss ./bin/max -w -pt1     # macOS
```

## Contributing

See `HACKING` for coding style and contribution guidelines.
